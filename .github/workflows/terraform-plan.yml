name: Terraform Plan on PR

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  # Stage 2: Generate the Terraform plan after validation succeeds.
  plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ./terraform-aws-s3-demo/

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false -out=tfplan
        working-directory: ./terraform-aws-s3-demo/

      - name: Upload Terraform Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform-aws-s3-demo/tfplan
          if-no-files-found: error 

  notify-on-success:
    name: 'Slack Notify on Success'
    runs-on: ubuntu-latest
    needs: plan 
    if: success() # Condition to run only on success
    steps:
      - name: Slack Notification on Plan Success
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: 'C097G9TNLA1'
          payload: |
            {
              "text": "Terraform Plan Succeeded!",
              "attachments": [ { "color": "#36a64f", "blocks": [
                  { "type": "section", "text": { "type": "mrkdwn", "text": ":white_check_mark: *Terraform Plan Succeeded*" }},
                  { "type": "section", "text": { "type": "mrkdwn", "text": "The Terraform plan was generated successfully and the artifact is available for review." }},
                  { "type": "section", "fields": [
                      { "type": "mrkdwn", "text": "*Repository:*\n`${{ github.repository }}`" },
                      { "type": "mrkdwn", "text": "*Branch:*\n`${{ github.head_ref || github.ref_name }}`" },
                      { "type": "mrkdwn", "text": "*Workflow:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Plan Artifacts>" }
                    ]
                  }
              ] } ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}


  notify-on-failure:
    name: 'Slack Notify on Failure'
    runs-on: ubuntu-latest
    needs: plan 
    if: failure() # Condition to run only on failure
    steps:
      - name: Slack Notification on Plan Failure
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: 'C097G9TNLA1'
          payload: |
            {
              "text": "Terraform Plan Failed!",
              "attachments": [ { "color": "#e01e5a", "blocks": [
                  { "type": "section", "text": { "type": "mrkdwn", "text": ":warning: *Terraform Plan Failed!*" }},
                  { "type": "section", "text": { "type": "mrkdwn", "text": "An error occurred during the `terraform plan` workflow. Please check the logs." }},
                  { "type": "section", "fields": [
                      { "type": "mrkdwn", "text": "*Repository:*\n`${{ github.repository }}`" },
                      { "type": "mrkdwn", "text": "*Branch:*\n`${{ github.head_ref || github.ref_name }}`" },
                      { "type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`" },
                      { "type": "mrkdwn", "text": "*Workflow:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>" }
                    ]
                  }
              ] } ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}